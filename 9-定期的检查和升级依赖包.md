# 定期检查和升级依赖包

随着 Bug 修复、新功能的开发或者其他更新，我们应用的依赖包可能会过时。此时应用的依赖项越多，就越难跟上这些更新。过时的依赖包可能对安全构成威胁，并对性能产生负面影响。最新的软件包可防止漏洞，这意味着定期的依赖性检查和更新很重要。我们建议定期的对应用的依赖包做更新和安全检查，并升级到一个合适的版本。并且我们建议在应用的 pipeline 中加入这些检查任务，并在常规的开发过程中及时发现和升级。如果应用已经处于维护阶段，我们也建议定期执行这些检查并在需要的时候加以升级。

## 定期检查和升级依赖包的优点

1. 定期升级依赖可以让应用的安全性和代码的可用性都有保障。  
2. 定期升级依赖会让解决依赖版本冲突和代码兼容性变得容易。  
3. 更新依赖项可以获得新的依赖项版本提供的所有性能改进。 这些改进可以有多种形式，例如修复以前的性能问题、改进了实现和算法等。  
4. 升级依赖项不仅可以改进现有功能，还可以使用到以前不存在的新功能。这些新功能最终可能让我们更好的实现自己应用的新功能。

## 不定期检查和升级依赖包的弊端

1. 如果不及时更新依赖，将会使得产品难以维护，并可能导致开发人员的时间被常规的、无意义的工作占用。
2. 如果长期不更新依赖，会使应用面临无人问津的风险，之后在某一天需要进行改动的时候，面临大量的依赖包过期无法获取和版本升级造成的接口变化。这时就需要投入非常高的成本来让代码重新变得可用，甚至完全无法更新而变成遗留系统。
3. 当进行大的版本升级时，需要对应用程序进行更多的更改才能与较新的库兼容。这使得付出代价比及时更新依赖大得多。
4. 如果忽略升级依赖项，那么会面临无法在自己喜欢的平台上运行软件的可能。 例如，如果停止升级软件中的数据库驱动程序，那么将无法使用旧版本的数据库系统。这不仅会使应用变得过时且易受攻击，而且甚至可能无法从该数据库系统提供商处获得任何支持。  
5. 如果应用依赖于过时的依赖项而导致升级困难变得很难维护，会使得项目很难找到对这些旧技术有经验的人，甚至失去现有的维护者。

## 实施

### 手动检查

#### JS 篇

1. npm-outdated & npm-update 
   * npm outdated：可以使用 `npm outdated` 获取当前需要升级的包的信息。 
   * npm update: 会把所有的包升级到我们定义的需要的版本号。如果需要升级到最新的则需要使用@latest eg: `npm update cypress@latest`

2. npm-check-updates: 是一种更高级的检查工具
   * 首先需要全局安装 npm-check-updates: `npm install -g npm-check-updates `
   * ncu: 检查需要升级的包信息，这里类似 `npm outdated`
   * ncu --upgrade/ncu -u: 将所有的包升级到最新版本，即便是包含重大更改，也会进行更新。注意：更新完成后不会自动运行 npm install，所以还需要再手动执行来更新 package-lock.json。   
   * ncu --interactive/ncu -i : interactive mode 安装某个包

**小结**：`npm-outdated` 和 `npm-check-updates`都可以用来做 `JS`项目的包检查、升级。

#### Java 篇

1. 在 build.gradle中配置 `owasp.dependency-check`
2. 执行` ./gradlew dependencyCheckAnalyze`
3. 查看报告： `项目根目录>build>reports>dependency-check-report.html `

### CI Pipeline 集成

1. npm-check-updates 与 Buildkite Pipeline 的集成	

   由于 buildkite 没有官方插件支持 dependency-check。所以对于buildkite 推荐两种方式：

   * 自己开发对应功能的插件，然后集成到 pipeline 的 step 中；
   * 通过 docker-compose 的方式去运行对应的检查，将其在 pipeline 的 step 中去运行（如果需要可以添加 block 来强制检查 npm-check-updates 的结果）。

   ```
   ## Dockerfile
   FROM node:18.7.0
   WORKDIR app
   COPY ["package.json", "package-lock.json*", "./"]
   RUN npm install -g npm-check-updates
   ```

   ```
   ## docker-compose
   version: "2"

   services:
     node-version-check:
       build: .
       command: sh -c "ncu"
   ```

   ```
   ## auto/dependency-check.sh
   #!/usr/bin/env bash

   set -ex
   docker-compose run --rm node-version-check

   ```

   ```
   ## buildkite script
   steps
      - label: 'node version dependency-check'
        command: auto/dependency-check.sh
        agents:
          queue: ‘xxxx’
    
      -  block: ‘Please check node-version-check’
   ```

2. jenkins pipeline 的集成：需要安装 dependency-check Plugin。步骤如下：
   1. 在 Jenkins Global Tool Configuration 安装 dependency-check；
   2. 在 Jenkins builder 配置已经安装好的 dependency-check；
   3. 在 Jenkins Publish 里配置读取 dependency-check 的 report ，通过对相关指标进行读取，设置阈值，配置构建失败或者警告等设置。

### 工具集成检查
如果项目 code 托管在 Github，我们可以使用 Dependabot 和 Renovate 工具和 Github 集成来做依赖检查。这两个工具都会做定期扫描，创建依赖版本升级的 PR。
#### 配置 DependaBot 进行版本更新

1. 在 GitHub 的代码仓库的主页,找到代码仓库名称下的 `setting`；
2. 在边栏的`安全性`部分中，单击`代码安全性和分析`；
3. 在`代码安全和分析`下，在`Dependabot version updates`右侧，单击`启用`以打开存储库 `.github` 目录中的基本 dependabot.yml 配置文件；
4. 添加`version`；
5. 添加 `updates` 部分，并输入希望 Dependabot 监视的每个包管理器的条目；
6. 对于每个包管理器，可使用：
   - `package-ecosystem` 指定包管理器。
   - `directory` 指定清单或其他定义文件的位置。
   - `schedule.interval` 指定检查新版本的频率。
7. 在代码仓库的根目录创建`.github`目录；
8. 创建 `dependabot.yml`文件并且存储到`.github`目录下。

示例 `dependabot.yml`

```
version: 2
updates:
  # Enable version updates for npm
  - package-ecosystem: "npm"
    # Look for `package.json` and `lock` files in the `root` directory
    directory: "/"
    # Check the npm registry for updates every day (weekdays)
    schedule:
      interval: "daily"
```

#### 配置 Renovate

1. 在 Github 的 App 里面安装 Renovate app https://github.com/apps/renovate；
2. 安装并配置完成后可以在PR中看到一个自动生成的PR `Configure Renovate`，这个PR中包含一个 `renovate.json` 文件，这个文件中包含了 renovate 的一些默认设定；
3. 可以根据文档(https://docs.renovatebot.com/configuration-options/)添加或者修改适合自身项目的具体配置项;
4. merge 此 PR；
5. Renovate 会根据你配置的 schedule 时间去自动的扫描并生成包升级 PR 提醒
